<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug - Erro 500 Persistente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            background-color: #f8f9fa;
        }
        .fix-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .fix-item {
            border-left: 4px solid #dc3545;
            padding: 1rem;
            margin: 1rem 0;
            background: #f8f9fa;
        }
        .fix-item.fixed {
            border-left-color: #28a745;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <h1 class="mb-4">üîç Debug - Erro 500 Persistente</h1>
        
        <div class="error">
            <strong>‚ùå PROBLEMA IDENTIFICADO:</strong><br>
            Ainda h√° erros 500 (Internal Server Error) na API de disciplinas, mesmo ap√≥s as corre√ß√µes anteriores. O erro ocorre na linha 2563 quando `startEditDisciplina` √© chamado.
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è AN√ÅLISE DO PROBLEMA:</strong><br>
            O erro 500 persistente pode ser causado por:
            <ul>
                <li>Problemas de autentica√ß√£o/sess√£o</li>
                <li>Erros na classe Database</li>
                <li>Problemas de permiss√£o de arquivo</li>
                <li>Depend√™ncias n√£o encontradas</li>
                <li>Erros de sintaxe PHP</li>
            </ul>
        </div>

        <div class="fix-item fixed">
            <h5><i class="fas fa-code text-primary me-2"></i>Solu√ß√£o 1: API de Debug</h5>
            <p><strong>Criada API simplificada para debug:</strong></p>
            <div class="code-block">
// Arquivo: admin/api/disciplinas-debug.php
<?php
// Configura√ß√µes b√°sicas
header('Content-Type: application/json; charset=utf-8');

// Iniciar sess√£o se n√£o estiver iniciada
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

// Log de debug
error_log('[API Disciplinas Debug] Iniciando requisi√ß√£o');

try {
    require_once __DIR__ . '/../../includes/database.php';
    
    $db = Database::getInstance();
    $cfcId = 1; // CFC ID fixo para debug
    
    // Criar tabela se n√£o existir
    $db->query("CREATE TABLE IF NOT EXISTS disciplinas (...)");
    
    // Inserir disciplinas padr√£o
    // ... c√≥digo simplificado ...
    
    if ($action === 'listar') {
        $sql = "SELECT * FROM disciplinas WHERE cfc_id = ? AND ativa = 1 ORDER BY nome ASC";
        $disciplinas = $db->fetchAll($sql, [$cfcId]);
        
        echo json_encode([
            'success' => true,
            'disciplinas' => $disciplinas ?: []
        ]);
    }
    
} catch (Exception $e) {
    error_log('[API Disciplinas Debug] Erro: ' . $e->getMessage());
    echo json_encode(['success' => false, 'error' => $e->getMessage()]);
}
?>
            </div>
        </div>

        <div class="fix-item fixed">
            <h5><i class="fas fa-code text-primary me-2"></i>Solu√ß√£o 2: JavaScript Atualizado</h5>
            <p><strong>Modificado JavaScript para usar API de debug:</strong></p>
            <div class="code-block">
// ANTES (com erro 500)
fetch('/cfc-bom-conselho/admin/api/disciplinas.php?action=listar')

// DEPOIS (usando API debug)
fetch('/cfc-bom-conselho/admin/api/disciplinas-debug.php?action=listar')
            </div>
        </div>

        <div class="fix-item fixed">
            <h5><i class="fas fa-tools text-warning me-2"></i>Solu√ß√£o 3: Arquivo de Teste</h5>
            <p><strong>Criado arquivo de teste para diagnosticar problemas:</strong></p>
            <div class="code-block">
// Arquivo: admin/teste-api-disciplinas.html
- Testa ambas as APIs (original e debug)
- Mostra status HTTP e resposta
- Exibe erros detalhados
- Interface visual para debug
            </div>
        </div>

        <div class="success">
            <h5><i class="fas fa-check-circle text-success me-2"></i>Melhorias Implementadas</h5>
            <ul>
                <li><strong>‚úÖ API de debug:</strong> Vers√£o simplificada sem depend√™ncias complexas</li>
                <li><strong>‚úÖ Logs detalhados:</strong> error_log para rastrear problemas</li>
                <li><strong>‚úÖ Tratamento de exce√ß√µes:</strong> try-catch com mensagens espec√≠ficas</li>
                <li><strong>‚úÖ CFC ID fixo:</strong> Evita problemas de autentica√ß√£o</li>
                <li><strong>‚úÖ Verifica√ß√µes de classe:</strong> class_exists para Database</li>
                <li><strong>‚úÖ JavaScript atualizado:</strong> Usa API de debug temporariamente</li>
                <li><strong>‚úÖ Arquivo de teste:</strong> Interface para diagnosticar problemas</li>
            </ul>
        </div>

        <div class="success">
            <h5><i class="fas fa-play text-info me-2"></i>Como Testar</h5>
            <ol>
                <li><strong>Acesse o arquivo de teste:</strong> <code>admin/teste-api-disciplinas.html</code></li>
                <li><strong>Clique em "Testar API de Disciplinas"</strong></li>
                <li><strong>Compare as respostas:</strong> API original vs API debug</li>
                <li><strong>Verifique os logs:</strong> error_log do PHP</li>
                <li><strong>Teste na p√°gina principal:</strong> Clique em disciplinas</li>
            </ol>
        </div>

        <div class="warning">
            <strong>üîç Pr√≥ximos Passos:</strong><br>
            <ol>
                <li>Execute o teste para identificar a causa exata do erro 500</li>
                <li>Verifique os logs do servidor PHP</li>
                <li>Se a API debug funcionar, o problema est√° na API original</li>
                <li>Se ambas falharem, o problema est√° na configura√ß√£o do servidor</li>
                <li>Corrija o problema identificado e volte para a API original</li>
            </ol>
        </div>

        <div class="text-center mt-4">
            <a href="admin/teste-api-disciplinas.html" class="btn btn-success btn-lg">
                <i class="fas fa-play me-2"></i>Executar Teste de API
            </a>
            <a href="?page=turmas-teoricas&acao=detalhes&turma_id=6" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-eye me-2"></i>Testar na P√°gina Principal
            </a>
        </div>
    </div>

    <script>
        console.log('üîç [DEBUG] Arquivo de debug carregado');
        console.log('üîç [DEBUG] Execute o teste de API para diagnosticar o problema');
    </script>
</body>
</html>
