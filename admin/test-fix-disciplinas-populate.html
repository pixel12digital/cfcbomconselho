<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Corre√ß√£o do Carregamento de Disciplinas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            background-color: #f8f9fa;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* ==========================================
           ESTILOS RESPONSIVOS PARA CAMPO DE DISCIPLINA
           ========================================== */

        /* Layout flex√≠vel para o campo de disciplina */
        .disciplina-row-layout {
            width: 100%;
            min-height: 48px;
        }

        .disciplina-field-container {
            min-width: 0; /* Permite que o campo encolha */
        }

        .disciplina-field-container .form-select {
            width: 100%;
            min-height: 48px;
            font-size: 1rem;
            padding: 0.75rem 1rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .disciplina-field-container .form-select:focus {
            border-color: #023A8D;
            box-shadow: 0 0 0 0.2rem rgba(2, 58, 141, 0.25);
        }

        .disciplina-delete-btn {
            min-width: 48px;
            height: 48px;
            padding: 0.5rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s ease-in-out;
        }

        .disciplina-delete-btn:hover {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
            transform: scale(1.05);
        }

        .disciplina-delete-btn:active {
            transform: scale(0.95);
        }

        .status {
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-weight: 500;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .demo-section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .demo-title {
            font-weight: 600;
            color: #023A8D;
            margin-bottom: 1rem;
        }

        .responsive-info {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #023A8D;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            display: block;
        }

        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .log-info { background-color: #d1ecf1; color: #0c5460; }
        .log-success { background-color: #d4edda; color: #155724; }
        .log-warning { background-color: #fff3cd; color: #856404; }
        .log-error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="mb-4">üîß Teste - Corre√ß√£o do Carregamento de Disciplinas</h1>
        
        <div class="status success">
            ‚úÖ <strong>Problema identificado e corrigido!</strong><br>
            O select de disciplinas n√£o estava sendo populado porque a fun√ß√£o estava usando vari√°veis n√£o inicializadas corretamente.
        </div>

        <div class="status info">
            <h6><i class="fas fa-info-circle me-2"></i>Corre√ß√µes implementadas:</h6>
            <ul class="mb-0">
                <li><strong>API direta:</strong> Fun√ß√£o `carregarDisciplinas` agora chama a API diretamente</li>
                <li><strong>Logs detalhados:</strong> Adicionados logs para debug das requisi√ß√µes</li>
                <li><strong>Tratamento de erros:</strong> Melhor tratamento de erros na API</li>
                <li><strong>Compatibilidade:</strong> Mantida compatibilidade com c√≥digo existente</li>
            </ul>
        </div>

        <div class="demo-section">
            <h5 class="demo-title">üß™ Teste do Carregamento de Disciplinas</h5>
            
            <div class="form-group">
                <label for="curso_tipo">
                    <i class="fas fa-graduation-cap me-1"></i>Tipo de Curso *
                </label>
                <select id="curso_tipo" name="curso_tipo" class="form-control" onchange="testarCarregamentoDisciplinas()">
                    <option value="">Selecione o tipo de curso...</option>
                    <option value="formacao_condutores">Curso de forma√ß√£o de condutores - Permiss√£o 45h</option>
                    <option value="reciclagem">Curso de reciclagem de condutores</option>
                    <option value="curso_moto">Curso de forma√ß√£o para motociclistas</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <i class="fas fa-book me-1"></i>Disciplinas do Curso
                </label>
                
                <!-- Campo fixo de disciplina -->
                <div class="disciplina-item border rounded p-3 mb-3" data-disciplina-id="0">
                    <div class="d-flex align-items-center gap-3 disciplina-row-layout">
                        <div class="flex-grow-1 disciplina-field-container">
                            <select class="form-select" name="disciplina_0" id="disciplina_principal" onchange="atualizarDisciplinaFixa(0)">
                                <option value="">Selecione a disciplina...</option>
                            </select>
                        </div>
                        <div class="flex-shrink-0">
                            <button type="button" class="btn btn-outline-danger btn-sm disciplina-delete-btn" onclick="removerDisciplinaFixa(0)" title="Remover disciplina" style="display: none;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="testarAPI()" style="font-size: 0.8rem;">
                    <i class="fas fa-sync me-1"></i>Testar API Diretamente
                </button>
            </div>
        </div>

        <div class="demo-section">
            <h5 class="demo-title">üìã Log de Debug</h5>
            <div class="log-container" id="log-container">
                <div class="log-entry log-info">üîÑ Sistema de teste carregado - aguardando a√ß√µes...</div>
            </div>
        </div>

        <div class="demo-section">
            <h5 class="demo-title">üîß Compara√ß√£o - Antes vs Depois</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-danger">‚ùå Problema Anterior</h6>
                    <ul class="text-muted">
                        <li>Fun√ß√£o usava `disciplinasPorCurso` n√£o definida</li>
                        <li>Vari√°vel `disciplinasDisponiveis` vazia</li>
                        <li>Select n√£o era populado</li>
                        <li>Sem logs para debug</li>
                        <li>Usu√°rio via apenas "Selecione a disciplina..."</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-success">‚úÖ Solu√ß√£o Implementada</h6>
                    <ul class="text-muted">
                        <li>Chamada direta para API `disciplinas-clean.php`</li>
                        <li>Tratamento correto da resposta JSON</li>
                        <li>Select populado automaticamente</li>
                        <li>Logs detalhados para debug</li>
                        <li>Usu√°rio v√™ todas as disciplinas dispon√≠veis</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="status warning">
            <strong>‚ö†Ô∏è Para testar no sistema real:</strong>
            <ol class="mb-0 mt-2">
                <li>Acesse <code>admin/test-api-disciplinas.php</code> para verificar se a API est√° funcionando</li>
                <li>Abra o console do navegador (F12) para ver os logs detalhados</li>
                <li>Selecione um tipo de curso para ver as disciplinas sendo carregadas</li>
                <li>Verifique se o select √© populado corretamente</li>
            </ol>
        </div>

        <div class="text-center mt-4">
            <button class="btn btn-primary" onclick="window.close()">
                <i class="fas fa-check me-2"></i>Fechar Teste
            </button>
            <a href="test-api-disciplinas.php" class="btn btn-outline-primary ms-2">
                <i class="fas fa-database me-2"></i>Testar API
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        function testarCarregamentoDisciplinas() {
            const cursoSelect = document.getElementById('curso_tipo');
            const disciplinaSelect = document.getElementById('disciplina_principal');
            
            if (!cursoSelect.value) {
                log('‚ö†Ô∏è Nenhum curso selecionado', 'warning');
                return;
            }
            
            log(`üîÑ Carregando disciplinas para curso: ${cursoSelect.value}`, 'info');
            
            // Simular o comportamento da fun√ß√£o corrigida
            disciplinaSelect.innerHTML = '<option value="">Carregando disciplinas...</option>';
            
            // Simular chamada para API (em produ√ß√£o seria a API real)
            setTimeout(() => {
                const disciplinasSimuladas = [
                    { id: 1, nome: 'Legisla√ß√£o de Tr√¢nsito', carga_horaria_padrao: 18 },
                    { id: 2, nome: 'Dire√ß√£o Defensiva', carga_horaria_padrao: 16 },
                    { id: 3, nome: 'Meio Ambiente e Cidadania', carga_horaria_padrao: 4 },
                    { id: 4, nome: 'Primeiros Socorros', carga_horaria_padrao: 4 },
                    { id: 5, nome: 'Mec√¢nica B√°sica', carga_horaria_padrao: 3 }
                ];
                
                disciplinaSelect.innerHTML = '<option value="">Selecione a disciplina...</option>';
                
                disciplinasSimuladas.forEach(disciplina => {
                    const option = document.createElement('option');
                    option.value = disciplina.id;
                    option.textContent = disciplina.nome;
                    option.dataset.aulas = disciplina.carga_horaria_padrao;
                    option.dataset.cor = '#007bff';
                    disciplinaSelect.appendChild(option);
                });
                
                log(`‚úÖ ${disciplinasSimuladas.length} disciplinas carregadas com sucesso`, 'success');
            }, 1000);
        }

        function testarAPI() {
            log('üß™ Testando API diretamente...', 'info');
            
            fetch('/cfc-bom-conselho/admin/api/disciplinas-clean.php?acao=listar')
                .then(response => {
                    log(`üì° Resposta da API: ${response.status}`, 'info');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    log(`üìÑ Resposta recebida (${text.length} caracteres)`, 'info');
                    try {
                        const data = JSON.parse(text);
                        if (data.sucesso && data.disciplinas) {
                            log(`‚úÖ API funcionando! ${data.disciplinas.length} disciplinas encontradas`, 'success');
                            data.disciplinas.forEach(d => {
                                log(`  üìö ${d.nome} (${d.carga_horaria_padrao}h)`, 'info');
                            });
                        } else {
                            log(`‚ùå API retornou erro: ${data.mensagem || 'Erro desconhecido'}`, 'error');
                        }
                    } catch (e) {
                        log(`‚ùå Erro ao fazer parse do JSON: ${e.message}`, 'error');
                        log(`üìÑ Texto recebido: ${text.substring(0, 200)}...`, 'warning');
                    }
                })
                .catch(error => {
                    log(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
                });
        }

        function atualizarDisciplinaFixa(disciplinaId) {
            const disciplinaSelect = document.querySelector(`select[name="disciplina_${disciplinaId}"]`);
            const deleteBtn = document.querySelector(`[data-disciplina-id="${disciplinaId}"] .disciplina-delete-btn`);
            
            if (!disciplinaSelect) return;
            
            const selectedOption = disciplinaSelect.options[disciplinaSelect.selectedIndex];
            
            if (selectedOption.value) {
                // Mostrar bot√£o de excluir
                if (deleteBtn) {
                    deleteBtn.style.display = 'flex';
                }
                
                log(`‚úÖ Disciplina selecionada: ${selectedOption.textContent}`, 'success');
            } else {
                // Esconder bot√£o de excluir
                if (deleteBtn) {
                    deleteBtn.style.display = 'none';
                }
            }
        }

        function removerDisciplinaFixa(disciplinaId) {
            const disciplinaSelect = document.querySelector(`select[name="disciplina_${disciplinaId}"]`);
            const deleteBtn = document.querySelector(`[data-disciplina-id="${disciplinaId}"] .disciplina-delete-btn`);
            
            if (disciplinaSelect) {
                disciplinaSelect.value = '';
                disciplinaSelect.innerHTML = '<option value="">Selecione a disciplina...</option>';
                
                if (deleteBtn) {
                    deleteBtn.style.display = 'none';
                }
                
                log('üóëÔ∏è Sele√ß√£o de disciplina removida', 'info');
            }
        }

        // Log inicial
        log('üéØ Sistema de teste de corre√ß√£o carregado', 'info');
        log('üìã Selecione um tipo de curso para testar o carregamento de disciplinas', 'info');
    </script>
</body>
</html>
