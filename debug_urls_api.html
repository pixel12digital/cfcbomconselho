<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug URLs de API - Sistema CFC</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background-color: #f8f9fa; border-radius: 3px; border-left: 4px solid #007bff; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .url-test { background: #e9ecef; padding: 10px; margin: 5px 0; border-radius: 4px; font-family: monospace; }
        .url-test.correct { background: #d4edda; border-left: 4px solid #28a745; }
        .url-test.incorrect { background: #f8d7da; border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Debug URLs de API - Sistema CFC</h1>
        
        <div class="debug-section info">
            <h3>üìã Problema Identificado</h3>
            <p>As URLs das APIs est√£o sendo constru√≠das incorretamente, resultando em:</p>
            <ul>
                <li><strong>URL Incorreta:</strong> <code>/admin/admin/api/instrutores.php</code> (duplica√ß√£o de /admin/)</li>
                <li><strong>URL Correta:</strong> <code>/admin/api/instrutores.php</code></li>
            </ul>
        </div>

        <div class="debug-section">
            <h3>üîß Teste da Configura√ß√£o Atual</h3>
            <button onclick="testarConfigAtual()">Testar Configura√ß√£o Atual</button>
            <div id="resultadoConfigAtual" class="result"></div>
        </div>

        <div class="debug-section">
            <h3>üß™ Teste de URLs Simuladas</h3>
            <button onclick="testarURLsSimuladas()">Testar URLs Simuladas</button>
            <div id="resultadoURLsSimuladas" class="result"></div>
        </div>

        <div class="debug-section">
            <h3>üîç An√°lise do Problema</h3>
            <button onclick="analisarProblema()">Analisar Problema</button>
            <div id="resultadoAnalise" class="result"></div>
        </div>

        <div class="debug-section">
            <h3>‚úÖ Solu√ß√£o Proposta</h3>
            <button onclick="testarSolucao()">Testar Solu√ß√£o</button>
            <div id="resultadoSolucao" class="result"></div>
        </div>

        <div class="debug-section">
            <h3>üìä Logs de Debug</h3>
            <div id="logsDebug" class="result">
                <p>Aguardando execu√ß√£o dos testes...</p>
            </div>
        </div>
    </div>

    <script>
        // Simular a configura√ß√£o atual (problem√°tica)
        const API_CONFIG_ATUAL = {
            get BASE_URL() {
                const path = window.location.pathname;
                // Se estiver em /admin/, remover apenas o /admin/ da URL
                if (path.includes('/admin/')) {
                    return window.location.origin + path.replace(/\/admin\/.*$/, '');
                }
                // Se n√£o estiver em /admin/, usar a URL base
                return window.location.origin + path.replace(/\/[^\/]*$/, '');
            },
            ENDPOINTS: {
                INSTRUTORES: 'admin/api/instrutores.php',
                USUARIOS: 'admin/api/usuarios.php',
                CFCs: 'admin/api/cfcs.php'
            },
            getApiUrl: function(endpoint) {
                return this.BASE_URL + '/' + this.ENDPOINTS[endpoint];
            },
            getRelativeApiUrl: function(endpoint) {
                return this.ENDPOINTS[endpoint];
            }
        };

        // Fun√ß√£o para adicionar logs
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logsDebug');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.className = type;
            logsDiv.appendChild(logEntry);
        }

        function testarConfigAtual() {
            const resultado = document.getElementById('resultadoConfigAtual');
            addLog('üîß Testando configura√ß√£o atual...', 'info');
            
            try {
                const baseUrl = API_CONFIG_ATUAL.BASE_URL;
                const instrutoresUrl = API_CONFIG_ATUAL.getApiUrl('INSTRUTORES');
                const instrutoresRelativo = API_CONFIG_ATUAL.getRelativeApiUrl('INSTRUTORES');
                
                addLog(`Base URL: ${baseUrl}`, 'info');
                addLog(`URL Completa Instrutores: ${instrutoresUrl}`, 'info');
                addLog(`URL Relativa Instrutores: ${instrutoresRelativo}`, 'info');
                
                // Verificar se h√° duplica√ß√£o
                const hasDuplication = instrutoresUrl.includes('/admin/admin/');
                
                if (hasDuplication) {
                    addLog('‚ùå PROBLEMA DETECTADO: Duplica√ß√£o de /admin/', 'error');
                    resultado.innerHTML = `
                        <div class="error">
                            <strong>‚ùå Problema Confirmado!</strong><br>
                            <strong>Base URL:</strong> ${baseUrl}<br>
                            <strong>URL Completa Instrutores:</strong> ${instrutoresUrl}<br>
                            <strong>URL Relativa Instrutores:</strong> ${instrutoresRelativo}<br>
                            <br>
                            <strong>Problema:</strong> A URL cont√©m "/admin/admin/" duplicado!
                        </div>
                    `;
                } else {
                    addLog('‚úÖ Configura√ß√£o funcionando corretamente', 'success');
                    resultado.innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Configura√ß√£o funcionando!</strong><br>
                            <strong>Base URL:</strong> ${baseUrl}<br>
                            <strong>URL Completa Instrutores:</strong> ${instrutoresUrl}<br>
                            <strong>URL Relativa Instrutores:</strong> ${instrutoresRelativo}
                        </div>
                    `;
                }
                
                console.log('üîß Configura√ß√£o atual:', API_CONFIG_ATUAL);
                console.log('üåê Base URL:', API_CONFIG_ATUAL.BASE_URL);
                
            } catch (error) {
                addLog(`‚ùå Erro na configura√ß√£o: ${error.message}`, 'error');
                resultado.innerHTML = `<div class="error"><strong>‚ùå Erro:</strong> ${error.message}</div>`;
            }
        }

        function testarURLsSimuladas() {
            const resultado = document.getElementById('resultadoURLsSimuladas');
            addLog('üß™ Testando URLs simuladas...', 'info');
            
            // Simular diferentes contextos de URL
            const contextos = [
                { path: '/cfc-bom-conselho/admin/index.php', desc: 'Admin index' },
                { path: '/cfc-bom-conselho/admin/pages/instrutores.php', desc: 'P√°gina instrutores' },
                { path: '/cfc-bom-conselho/admin/', desc: 'Admin raiz' },
                { path: '/cfc-bom-conselho/', desc: 'Raiz do projeto' }
            ];
            
            let html = '<h4>Teste de URLs em diferentes contextos:</h4>';
            
            contextos.forEach(contexto => {
                // Simular window.location.pathname
                const originalPathname = window.location.pathname;
                Object.defineProperty(window.location, 'pathname', {
                    value: contexto.path,
                    writable: true
                });
                
                const baseUrl = API_CONFIG_ATUAL.BASE_URL;
                const apiUrl = API_CONFIG_ATUAL.getApiUrl('INSTRUTORES');
                const hasDuplication = apiUrl.includes('/admin/admin/');
                
                const urlClass = hasDuplication ? 'incorrect' : 'correct';
                const status = hasDuplication ? '‚ùå' : '‚úÖ';
                
                html += `
                    <div class="url-test ${urlClass}">
                        <strong>${status} ${contexto.desc}</strong><br>
                        <strong>Path:</strong> ${contexto.path}<br>
                        <strong>Base URL:</strong> ${baseUrl}<br>
                        <strong>API URL:</strong> ${apiUrl}<br>
                        <strong>Status:</strong> ${hasDuplication ? 'DUPLICA√á√ÉO DETECTADA' : 'OK'}
                    </div>
                `;
                
                addLog(`${status} ${contexto.desc}: ${apiUrl}`, hasDuplication ? 'error' : 'success');
            });
            
            // Restaurar pathname original
            Object.defineProperty(window.location, 'pathname', {
                value: originalPathname,
                writable: true
            });
            
            resultado.innerHTML = html;
        }

        function analisarProblema() {
            const resultado = document.getElementById('resultadoAnalise');
            addLog('üîç Analisando problema...', 'info');
            
            const path = window.location.pathname;
            addLog(`Path atual: ${path}`, 'info');
            
            // Analisar a l√≥gica atual
            const logicaAtual = `
                <h4>An√°lise da L√≥gica Atual:</h4>
                <pre>
// L√≥gica atual (problem√°tica):
get BASE_URL() {
    const path = window.location.pathname;
    if (path.includes('/admin/')) {
        return window.location.origin + path.replace(/\/admin\/.*$/, '');
    }
    return window.location.origin + path.replace(/\/[^\/]*$/, '');
}

// Problema identificado:
// 1. path = "/cfc-bom-conselho/admin/index.php"
// 2. path.includes('/admin/') = true
// 3. path.replace(/\/admin\/.*$/, '') = "/cfc-bom-conselho"
// 4. BASE_URL = "http://localhost:8080/cfc-bom-conselho"
// 5. getApiUrl('INSTRUTORES') = "http://localhost:8080/cfc-bom-conselho/admin/api/instrutores.php"
// 6. Mas quando usado em contexto /admin/, resulta em duplica√ß√£o
                </pre>
            `;
            
            resultado.innerHTML = logicaAtual;
            addLog('üìä An√°lise conclu√≠da - problema identificado na l√≥gica de c√°lculo', 'warning');
        }

        function testarSolucao() {
            const resultado = document.getElementById('resultadoSolucao');
            addLog('‚úÖ Testando solu√ß√£o...', 'info');
            
            // Solu√ß√£o proposta: usar sempre URL relativa
            const API_CONFIG_CORRIGIDO = {
                ENDPOINTS: {
                    INSTRUTORES: 'admin/api/instrutores.php',
                    USUARIOS: 'admin/api/usuarios.php',
                    CFCs: 'admin/api/cfcs.php'
                },
                getRelativeApiUrl: function(endpoint) {
                    return this.ENDPOINTS[endpoint];
                },
                getApiUrl: function(endpoint) {
                    // Sempre usar URL relativa para evitar problemas de contexto
                    return this.getRelativeApiUrl(endpoint);
                }
            };
            
            const urls = {
                'Instrutores': API_CONFIG_CORRIGIDO.getRelativeApiUrl('INSTRUTORES'),
                'Usu√°rios': API_CONFIG_CORRIGIDO.getRelativeApiUrl('USUARIOS'),
                'CFCs': API_CONFIG_CORRIGIDO.getRelativeApiUrl('CFCs')
            };
            
            addLog('URLs corrigidas:', 'info');
            Object.entries(urls).forEach(([nome, url]) => {
                addLog(`${nome}: ${url}`, 'info');
            });
            
            // Verificar se n√£o h√° duplica√ß√£o
            const hasDuplication = Object.values(urls).some(url => url.includes('/admin/admin/'));
            
            if (!hasDuplication) {
                addLog('‚úÖ Solu√ß√£o funcionando! Sem duplica√ß√£o detectada', 'success');
                resultado.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Solu√ß√£o Aplicada com Sucesso!</strong><br>
                        <br>
                        <strong>Princ√≠pio da Solu√ß√£o:</strong><br>
                        - Usar sempre URLs relativas em vez de absolutas<br>
                        - Evitar c√°lculo complexo de BASE_URL<br>
                        - URLs sempre corretas independente do contexto<br>
                        <br>
                        <strong>URLs Corrigidas:</strong><br>
                        ${Object.entries(urls).map(([nome, url]) => `<strong>${nome}:</strong> ${url}`).join('<br>')}
                    </div>
                `;
            } else {
                addLog('‚ùå Solu√ß√£o ainda tem problemas', 'error');
                resultado.innerHTML = `<div class="error"><strong>‚ùå Problema persistente:</strong> Ainda h√° duplica√ß√£o</div>`;
            }
        }

        // Log inicial
        addLog('üöÄ P√°gina de debug carregada', 'info');
        addLog(`üîß API_CONFIG_ATUAL dispon√≠vel: ${typeof API_CONFIG_ATUAL !== 'undefined'}`, 'info');
        addLog(`üåê Path atual: ${window.location.pathname}`, 'info');
        
        console.log('üêõ P√°gina de debug das URLs de API carregada');
        console.log('üîß API_CONFIG_ATUAL:', API_CONFIG_ATUAL);
    </script>
</body>
</html>
