name: ðŸš€ Deploy FIXED - CFC Bom Conselho

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Hostinger
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‹ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Deploy via SSH (Fixed)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOSTINGER_HOST }}
        username: ${{ secrets.HOSTINGER_USERNAME }}
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        port: ${{ secrets.HOSTINGER_PORT || '22' }}
        script: |
          set -e
          
          echo "ðŸš€ [$(date)] Deploy iniciado..." >> /tmp/deploy.log
          
          # Verificar se estamos no diretÃ³rio correto
          if [ ! -d "/public_html" ]; then
            echo "âŒ Erro: DiretÃ³rio /public_html nÃ£o existe" >> /tmp/deploy.log
            exit 1
          fi
          
          cd /public_html || { echo "âŒ Erro: NÃ£o consegui entrar em /public_html" >> /tmp/deploy.log; exit 1; }
          
          # Criar backup rÃ¡pido
          BACKUP_DIR="/backups/backup-$(date +%Y%m%d-%H%M%S)"
          echo "ðŸ’¾ Criando backup em: $BACKUP_DIR" >> /tmp/deploy.log
          mkdir -p "$BACKUP_DIR"
          cp -r ./* "$BACKUP_DIR/" 2>/dev/null || true
          
          # Git pull simples
          echo "ðŸ“¥ Fazendo pull do cÃ³digo..." >> /tmp/deploy.log
          
          # Se nÃ£o for um repositÃ³rio Git ainda, clonar
          if [ ! -d ".git" ]; then
            echo "ðŸ“ Clonando repositÃ³rio pela primeira vez..." >> /tmp/deploy.log
            rm -rf ./* 2>/dev/null || true
            git clone https://github.com/pixel12digital/cfcbomconselho.git .
          fi
          
          # Pull atualizaÃ§Ãµes
          git fetch origin
          git reset --hard origin/master
          git clean -fd
          
          # PermissÃµes
          echo "ðŸ”§ Ajustando permissÃµes..." >> /tmp/deploy.log
          find . -type f -name "*.php" -exec chmod 644 {} \; 2>/dev/null || true
          find . -type d -exec chmod 755 {} \; 2>/dev/null || true
          
          # Arquivo de versÃ£o
          echo "${{ github.sha }}" > .version
          echo "$(date)" >> .version
          
          echo "âœ… Deploy concluÃ­do com sucesso!" >> /tmp/deploy.log
